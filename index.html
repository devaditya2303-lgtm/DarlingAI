<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SarasAI â€” Smart Hybrid Chatbot</title>
<style>
  :root{
    --bg:#0b0f13; --panel:#0f1418; --muted:#9aa6b2; --accent:#6ad1ff;
    --bubble-user:#153447; --bubble-bot:#0b2530; --bubble-radius:18px;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial;background:linear-gradient(180deg,#030409 0%, #07101a 100%);color:#e6eef6}
  .container{max-width:920px;margin:20px auto;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:20px}
  .sub{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn,.iconbtn{background:var(--panel);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
  .iconbtn{width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center}
  .chat-wrap{margin-top:14px;border-radius:10px;background:var(--glass);padding:18px;height:520px;overflow:auto;border:1px solid rgba(255,255,255,0.02)}
  .messages{display:flex;flex-direction:column;gap:12px}
  .msg{max-width:78%;padding:12px 16px;border-radius:var(--bubble-radius);line-height:1.35;word-break:break-word;box-shadow:0 6px 20px rgba(0,0,0,0.4)}
  .user{align-self:flex-end;background:linear-gradient(180deg,var(--bubble-user),#0b3240);color:#e6f7ff;border-bottom-right-radius:6px;border-bottom-left-radius:18px}
  .bot{align-self:flex-start;background:linear-gradient(180deg,var(--bubble-bot),#07121b);color:#dff3ff;border-bottom-left-radius:6px;border-bottom-right-radius:18px}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  footer{display:flex;gap:8px;align-items:center;margin-top:12px}
  input[type="text"]{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:#08121a;color:#e8f6ff}
  .tiny{font-size:12px;color:var(--muted)}
  .personality{display:flex;gap:8px;align-items:center}
  .personality label{cursor:pointer;padding:6px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);color:var(--muted)}
  .activeP{background:linear-gradient(90deg,#143b4a,#0c2e3a);color:#bff0ff;border:1px solid rgba(106,209,255,0.15)}
  .leftnote{font-size:13px;color:var(--muted);margin-top:8px}
  .typing{display:inline-block;height:10px;width:36px;background:linear-gradient(90deg,#2a4b55,#0c2e3a);border-radius:6px;opacity:0.95;padding:6px}
  .smallbtn{padding:6px 8px;border-radius:8px}
</style>
</head>
<body>
<div class="container" role="application" aria-label="SarasAI chat">
  <header>
    <div>
      <h1>âœ¨ SarasAI â€” Smart Hybrid Chatbot</h1>
      <div class="sub">Dark Mode â€¢ Bubbles â€¢ Personalities â€¢ Voice & Text â€¢ Math & Smart rules</div>
    </div>
    <div class="controls">
      <div class="tiny">Voice Reply</div>
      <button id="toggleSpeak" class="btn smallbtn" title="Toggle voice replies">ON</button>
    </div>
  </header>

  <div style="margin-top:12px;display:flex;align-items:center;gap:12px">
    <div>
      <div class="tiny">Personality:</div>
      <div id="personalityBar" class="personality" role="tablist" aria-label="Choose personality">
        <label data-p="lovely" class="activeP">Lovely</label>
        <label data-p="teacher">Teacher</label>
        <label data-p="funny">Funny</label>
        <label data-p="caring">Caring</label>
      </div>
    </div>
    <div style="margin-left:auto"><button id="clearBtn" class="btn smallbtn">Clear chat</button></div>
  </div>

  <div id="chat-wrap" class="chat-wrap" aria-live="polite">
    <div id="messages" class="messages">
      <div class="meta">SarasAI ready â€” try: "Solve 2+2", "What is photosynthesis?", "Tell me a joke", or speak using the mic.</div>
    </div>
  </div>

  <footer>
    <button id="micBtn" class="iconbtn" title="Start voice input">ðŸŽ¤</button>
    <input id="input" type="text" placeholder="Type a message or press the mic to speak">
    <button id="sendBtn" class="btn">Send</button>
  </footer>

  <div class="leftnote">Tip: Type math like <code>2+2</code>, or say "solve 12 * 8". For conversions write "convert 10 km to m".</div>
</div>

<script>
/* =========================
   SarasAI: Smart + Rule + Mini-AI
   ========================= */

/* ---------- Knowledge & rules (expandable) ---------- */
const rules = [
  {q:["hello","hi","hey"], a:"Hello! How can I help you today?"},
  {q:["your name","who are you"], a:"I am SarasAI â€” your helpful chatbot."},
  {q:["who created you","creator"], a:"I was created lovingly by Mamatha."},
  {q:["hours","timing","open"], a:"SarasAI is available 24/7 for you."},
  {q:["bye","goodbye","see you"], a:"Goodbye! Come back soon â€” SarasAI will be here."},
  {q:["what tasks can you perform","what can you do"], a:"I can answer questions, solve math, convert units, give short explanations, tell jokes, write short poems, and help study."},
  {q:["tell me a joke","joke"], a:"Why did the computer get cold? Because it left its Windows open! ðŸ˜„"},
  {q:["poem","write a poem"], a:"Hereâ€™s a short poem:\nRays of code and gentle light,\nSarasAI listens through the night."},
  {q:["help","how to use"], a:"Type a question or press the mic and speak. Try math like 'solve 12/4' or ask 'what is gravity'."},
  {q:["study tips","how to study"], a:"Use short focused sessions (25-40 min), take small breaks, and practice by solving problems."},
  {q:["convert","conversion"], a:"Use: 'convert 10 km to m' or 'convert 5 kg to g'."},
  {q:["define","definition","what is"], a:"I can give a short definition. Ask like 'Define photosynthesis' or 'What is democracy'."}
];

/* ---------- Helpers & UI hooks ---------- */
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const clearBtn = document.getElementById('clearBtn');
const toggleSpeak = document.getElementById('toggleSpeak');
const personalityBar = document.getElementById('personalityBar');

let voiceReply = true;
let currentPersona = 'lovely';

/* ---------- Utility: escape HTML ---------- */
function escapeHtml(s){
  return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* ---------- Add message to UI ---------- */
function addMessage(text, who='bot', meta=false){
  const div = document.createElement('div');
  div.className = 'msg ' + (who==='user' ? 'user' : 'bot');
  const name = who==='user' ? 'You' : 'SarasAI';
  // preserve new lines
  const safe = escapeHtml(text).replace(/\n/g,'<br>');
  div.innerHTML = `<strong>${name}:</strong> ${safe}`;
  messagesEl.appendChild(div);
  const wrap = document.getElementById('chat-wrap');
  wrap.scrollTop = wrap.scrollHeight;
}

/* ---------- Personality modifiers ---------- */
function personaModify(text, persona){
  persona = persona || currentPersona;
  if(persona==='lovely'){
    return text + " ðŸ’™";
  }
  if(persona==='teacher'){
    return "ðŸ“˜ Teacher SarasAI: " + text;
  }
  if(persona==='funny'){
    return text + " ðŸ˜‚";
  }
  if(persona==='caring'){
    return "ðŸ’– " + text + " â€” take care!";
  }
  return text;
}

/* ---------- Rule matcher ---------- */
function matchRule(userText){
  const t = userText.toLowerCase();
  for(const r of rules){
    for(const kw of r.q){
      // match full words roughly
      if(t.includes(kw)) return r.a;
    }
  }
  return null;
}

/* ---------- Math evaluator (safe-ish) ----------
   Allows digits, spaces, + - * / ^ (we'll replace ^ with **), parentheses, decimals.
   Validates characters first.
-------------------------------------------------*/
function isMathExpression(s){
  // Remove spaces and common prefixes
  const t = s.trim().toLowerCase().replace(/^solve\s+|^calculate\s+|^what is\s+|^evaluate\s+/,'');
  // Only allow digits, operators, parentheses, decimal, spaces
  return /^[0-9\s+\-*/().,^]+$/.test(t);
}
function evalMath(s){
  const t = s.trim().toLowerCase().replace(/^solve\s+|^calculate\s+|^what is\s+|^evaluate\s+/,'');
  // replace ^ with **
  const safe = t.replace(/\^/g,'**');
  // final validation
  if(!/^[0-9\s+\-*/().,**^]+$/.test(safe) && !/^[0-9\s+\-*/().]+$/.test(safe)) {
    throw new Error('invalid characters');
  }
  // only numbers/operators/parentheses allowed
  if(!/^[0-9+\-*/().\s**]+$/.test(safe)) { /* continue, but be cautious */ }
  // allow only characters we expect
  if(!/^[0-9+\-*/().\s**]+$/.test(safe)) {
    // fallback: try to remove commas
  }
  // Basic safety: reject if too long
  if(safe.length > 200) throw new Error('expression too long');
  // Final check: allow digits, operators, parentheses, dot, spaces, **
  if(!/^[0-9+\-*/().\s*]+$/.test(safe.replace(/\*\*/g,'*'))) throw new Error('invalid expression');
  // Evaluate with Function (after validation)
  try{
    // replace accidental multiple dots
    const result = Function('"use strict"; return (' + safe + ')')();
    // Round floats sensibly
    if(typeof result === 'number' && !Number.isInteger(result)){
      return Number.parseFloat(result.toFixed(6)).toString();
    }
    return String(result);
  }catch(e){
    throw new Error('could not evaluate');
  }
}

/* ---------- Simple converter (distance, mass) ---------- */
function tryConvert(text){
  // pattern: convert 10 km to m
  const m = text.toLowerCase().match(/convert\s+([\d.]+)\s*(km|m|cm|mm|km|kg|g|lb|lbs|meter|metre|kilogram|gram|km)\s+to\s+(km|m|cm|mm|kg|g|lb|lbs|meter|metre|kilogram|gram)/);
  if(!m) return null;
  const val = parseFloat(m[1]);
  const from = m[2].replace(/meter|metre/,'m').replace(/kilogram/,'kg');
  const to = m[3].replace(/meter|metre/,'m').replace(/kilogram/,'kg');
  // distance conversions
  const dist = {
    km:1000, m:1, cm:0.01, mm:0.001
  };
  const mass = { kg:1000, g:1, lb:453.59237 };
  if(from in dist && to in dist){
    const inMeters = val * dist[from];
    const out = inMeters / dist[to];
    return `${val} ${from} = ${out} ${to}`;
  }
  if((from in mass) && (to in mass)){
    const inGrams = val * mass[from];
    const out = inGrams / mass[to];
    return `${val} ${from} = ${out} ${to}`;
  }
  return null;
}

/* ---------- Short explanation generator ----------
   For "what is X" fallback when not in rules.
   Gives a brief template-based answer.
---------------------------------------------------*/
function shortExplain(text){
  // e.g., "what is photosynthesis"
  const m = text.toLowerCase().match(/(?:what is|define)\s+(.+)/);
  const topic = m ? m[1] : text;
  // keep it short
  const first = topic.split(/[?,.]/)[0].trim();
  if(!first) return null;
  // templates for common topics
  const known = {
    photosynthesis: "Photosynthesis is the process plants use to convert sunlight into chemical energy (food), using water and carbon dioxide.",
    gravity: "Gravity is the force that pulls objects with mass toward each other; it's what keeps planets in orbit and objects on the ground.",
    democracy: "Democracy is a system of government where people choose leaders or decide on laws, usually by voting.",
    nucleus: "The nucleus is the control center of a cell where genetic material (DNA) is stored."
  };
  if(known[first]) return known[first];
  // generic short answer
  return `I don't have external web access, but briefly: ${capitalize(first)} is a topic I can explain. Ask me for a short explanation and I will summarize basic points.`;
}

/* capitalize helper */
function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

/* ---------- Fallback mini-AI: try to be natural ---------- */
function miniAI(user){
  const t = user.trim();
  // 1) Math detection
  if(isMathExpression(t)){
    try{
      const res = evalMath(t);
      return `Result: ${res}`;
    }catch(e){
      return "I couldn't calculate that expression. Try a simpler math like 2+2 or 12/3.";
    }
  }
  // 2) Conversion
  const conv = tryConvert(t);
  if(conv) return conv;
  // 3) Definition / what is
  if(/^(what is|define|definition of)/i.test(t)){
    const s = shortExplain(t);
    if(s) return s;
  }
  // 4) "tell me a story" / "write" / "poem"
  if(/story|write me a story|short story/i.test(t)){
    return "Hereâ€™s a short story:\nA student asked a kind bot a question at night â€” the bot answered gently, and the student smiled.";
  }
  if(/poem|write a poem/i.test(t)){
    return "A short poem:\nBright code that listens, soft and true,\nSarasAI whispers help to you.";
  }
  // 5) tasks / capabilities
  if(/what can you do|what tasks|help me with/i.test(t)){
    return "I can answer questions, solve math, convert units, give short explanations, tell jokes, write short poems, and help with study tasks.";
  }
  // 6) default friendly reply
  // Use small paraphrase to be natural
  const templates = [
    "I am still learning, but I can try: ",
    "Good question â€” hereâ€™s a short reply: ",
    "I'll try to help: "
  ];
  return templates[ Math.floor(Math.random()*templates.length) ] + `"${t}"` ;
}

/* ---------- Main pipeline ---------- */
function processUser(text){
  if(!text) return;
  addMessage(text,'user');
  // quick checks
  // 1) conversions
  const conv = tryConvert(text);
  if(conv){
    const out = personaModify(conv);
    setTimeout(()=>{ addMessage(out,'bot'); if(voiceReply) speakText(out); }, 400); return;
  }
  // 2) rule match
  const r = matchRule(text);
  if(r){
    const out = personaModify(r);
    setTimeout(()=>{ addMessage(out,'bot'); if(voiceReply) speakText(out); }, 300); return;
  }
  // 3) math check
  if(isMathExpression(text)){
    try{
      const ans = evalMath(text);
      const out = personaModify("Answer: " + ans);
      setTimeout(()=>{ addMessage(out,'bot'); if(voiceReply) speakText(out); }, 300); return;
    }catch(e){
      // proceed to miniAI fallback
    }
  }
  // 4) mini-AI fallback
  const fa = miniAI(text);
  const final = personaModify(fa);
  setTimeout(()=>{ addMessage(final,'bot'); if(voiceReply) speakText(final); }, 500);
}

/* ---------- Event bindings ---------- */
sendBtn.addEventListener('click', ()=>{ processUser(inputEl.value.trim()); inputEl.value=''; });
inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ processUser(inputEl.value.trim()); inputEl.value=''; }});
clearBtn.addEventListener('click', ()=>{ messagesEl.innerHTML = '<div class="meta">Chat cleared. SarasAI is ready â€” try math, conversions, or ask a question.</div>'; });

personalityBar.querySelectorAll('label').forEach(lbl=>{
  lbl.addEventListener('click', ()=>{
    personalityBar.querySelectorAll('label').forEach(l=>l.classList.remove('activeP'));
    lbl.classList.add('activeP');
    currentPersona = lbl.getAttribute('data-p');
    addMessage(`Switched personality to: ${currentPersona}.`,'bot');
  });
});

toggleSpeak.addEventListener('click', ()=>{
  voiceReply = !voiceReply;
  toggleSpeak.textContent = voiceReply ? 'ON' : 'OFF';
});

/* ---------- Speech synthesis (voice replies) ---------- */
function speakText(text){
  if(!('speechSynthesis' in window)) return;
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text.replace(/<[^>]*>/g,''));
    // pick a voice matching user's locale if possible
    const voices = speechSynthesis.getVoices();
    if(voices && voices.length){
      const v = voices.find(v=>/female|feminine|zira|kyoko|kathy|susan|english/i.test(v.name)) || voices[0];
      if(v) u.voice = v;
    }
    u.rate = 1;
    speechSynthesis.speak(u);
  }catch(e){ console.warn('speak error', e); }
}

/* ---------- Speech recognition (voice input) ---------- */
let recognition, listening=false;
if(window.SpeechRecognition || window.webkitSpeechRecognition){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'en-IN';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.onresult = (e)=>{
    const t = e.results[0][0].transcript;
    inputEl.value = t;
    processUser(t);
  };
  recognition.onend = ()=>{ listening=false; micBtn.classList.remove('mic-on'); micBtn.title='Start voice input'; };
  recognition.onerror = (ev)=>{ listening=false; micBtn.classList.remove('mic-on'); console.warn('speech error',ev); };
} else {
  micBtn.title = 'Voice input not supported in this browser';
}

micBtn.addEventListener('click', ()=>{
  if(!recognition){ alert('Voice input not supported in this browser. Use Chrome/Edge on desktop or Android.'); return; }
  if(listening){ recognition.stop(); listening=false; micBtn.classList.remove('mic-on'); micBtn.title='Start voice input'; }
  else { recognition.start(); listening=true; micBtn.classList.add('mic-on'); micBtn.title='Listening... click to stop'; }
});

/* announce ready */
window.addEventListener('load', ()=>{ setTimeout(()=>{ addMessage('Welcome! SarasAI ready. Try "Solve 2+2" or "Convert 5 km to m".'); },200); });

</script>
</body>
</html>
